<html>
	<head>
		<title>Clik Trivia</title>
		
		<link rel="stylesheet" href="css/desktop.css" />
		<link href="bootstrap/css/bootstrap.css" rel="stylesheet">
		
	</head>
	
	<body>
		<div class="container">
		
			<div class="hero-unit" style="padding: 30px;">
				<div style="height: 100px;">
					<div class="titlecontainer">
						<h1 class="white">Clik Trivia</h1>
						<p class="white">Challenge a friend to a 10 question game!</p>
					</div>
				</div>
			</div>
			
			<div class="row qrstatusrow">
				<div id="qrContainer">
				</div>
					
				<div id="gamesetup" class="well gameloading">
					<h2 id="gamesetup_title">Player is setting up game...</h2>
					<div id="progress" class="progress progress-info progress-striped active">
						<div class="bar" style="width: 100%;"></div>
					</div>
				</div>
				
				<div id="questions" class="questions">
					<h1 id="question_title">Get Ready!</h1>
					<br />
					<h1 id="question_value">Look at the phone :)</h1>
				</div>
				
			</div>
			
			<div id="scores" class="row" style="margin: 0 auto; display: none;">
				<div id="score1container" class="span5 well scorecontainer">
					<h1 id="score1">Player 1 - 0 pts</h1>
				</div>
				<div id="score2container" class="span5 well scorecontainer">
					<h1 id="score2">Player 2 - 0 pts</h1>
				</div>
			</div>
			
			<hr>
			<footer>
				<p>&copy; Ben 2012</p>
			</footer>
		</div>
	</body>
	<script src="http://live.betaclik.com/js/clik-desktop.min.js" type="text/javascript"></script>
	<script src="js/cliktriva.js" type="text/javascript"></script>
	<script src="manifest.js" type="text/javascript"></script>
	
	<!-- User JavaScript -->
	<script type="text/javascript">

		var questions = new questionGenerator();
		var clikTrivia = new ClikTrivia();
		var questionCount = 1;
		var questionAnswers = 0;
		var correctAnswers = 0;
		var currentQuestion;
		
		clik.onMessage = function(msg) {
		
			var msg = $.parseJSON(msg);
			
			if ( msg.action == "getplayers" )
			{
				//Were setting up a 2 player game
				if ( msg.count == 2 )
				{
					$("#qrContainer").show();
					$("#gamesetup_title").text("Player 2 Scan Now!!");
				}
				else
				{
					currentQuestion = questions.getQuestion(0);
					setQuestionDisplay();
						
					clik.sendMessage("{\"participant\":\"\", \"action\":\"startGame\", \"question\": " + questions.getQuestionJSON(currentQuestion) + "}");
					
					$("#qrContainer").hide();
					$("#gamesetup").hide();
					$("#scores").show();
					$("#questions").show();
					
					//change the score containter to full width and hide for player 2
					$("#score1container").removeClass("span5").addClass("span11");
					$("#score2container").hide();
				}
			}
			else if ( msg.action == "answer" )
			{
				questionAnswers++;
				
				//The answer is correct or the number of incorrect answers is equal to the number of players
				var correctAnswer = currentQuestion.correct == msg.pos;
				
				if ( correctAnswer )
				{
					correctAnswers++;
					clikTrivia.addScore(msg.participant, correctAnswers);
				
					//Update scores and question text
					$("#score1").text("Player 1 - " + clikTrivia.getScorePos(0) + " pts");
					$("#score2").text("Player 2 - " + clikTrivia.getScorePos(1) + " pts");
				}
					
				//Game over
				if ( questionCount == 10 )
				{							
					$("#question_title").text("Game Over!");
					
					if ( clikTrivia.getNumPlayers() > 1 )
					{
						if ( clikTrivia.getScorePos(0) > clikTrivia.getScorePos(1) )
						{							
							$("#question_value").text("Player 1 Wins!");
							sendGameOverMessage(clikTrivia.getPlayer(0));
						}
						else
						{
							$("#question_value").text("Player 2 Wins!");
							sendGameOverMessage(clikTrivia.getPlayer(1));
						}
					}
					else
					{
						$("#question_value").text("You scored " + clikTrivia.getScorePos(0) + " pts");
						sendGameOverMessage("");
					}
				}
				else
				{	
					if ( questionAnswers == clikTrivia.getNumPlayers() )
					{
						currentQuestion = questions.getQuestion();
						questionCount++;
						questionAnswers = 0;
						correctAnswers = 0;
						setQuestionDisplay();
						
						//Send next question to clients
						clik.sendMessage("{\"participant\":\"\", \"action\":\"startGame\", \"question\": " + questions.getQuestionJSON(currentQuestion) + "}");
					}
				}
			}
			else if ( msg.action == "restart" )
			{
				resetGame();
			}
		}
		
		// Whenever someone joins the conference.
		clik.onJoin = function(newParticipant) {
			
			//We know this is the first player to join lets ask them to configure the game
			if ( clikTrivia.checkPlayer(newParticipant) && clikTrivia.getNumPlayers() == 0)
			{
				clikTrivia.addPlayer(newParticipant);
				$("#qrContainer").hide();
				$("#gamesetup").show();
				clik.sendMessage("{\"participant\":\"" + newParticipant + "\", \"action\":\"choosePlayers\"}");
			}
			else if ( clikTrivia.checkPlayer(newParticipant) )
			{
				currentQuestion = questions.getQuestion();
				clikTrivia.addPlayer(newParticipant);
				
				//Delay the start so both clients can get connected
				setTimeout(function(){startGame(newParticipant)}, 2500);
			}
		}
		
		// Whenever someone leaves the conference.
		clik.onPart = function(oldParticipant) {
			resetGame();
		}
		
		// When we've successfully connected to the conference
		clik.onReady = function() {
			//clik.showClikCode();
			$("#qrContainer").css('background-image', 'url(' + clik.ui.clikCodeUrl() + ')');
			$("#conferenceId").val(clik.getConferenceId());
			$("#participantId").val(clik.getParticipantId());
		}
		
		// Finally, we tell Clik to initialize.
		clik.init();
		
		function startGame(newParticipant)
		{
			clik.sendMessage("{\"participant\":\"" + newParticipant + "\", \"action\":\"startGame\", \"question\": " + JSON.stringify(currentQuestion) + "}");
				
			$("#qrContainer").hide();
			$("#gamesetup").hide();
			$("#scores").show();
			$("#questions").show();
		}
		
		function resetGame()
		{
			clikTrivia = new ClikTrivia();
			questions = new questionGenerator();
			questionCount = 1;
			questionAnswers = 0;
			
			$("#score1").text("Player 1 - 0 pts");
			$("#score2").text("Player 2 - 0 pts");
			$("#gamesetup_title").text("Player is setting up game...");
			$("#qrContainer").show();
			$("#gamesetup").hide();
			$("#scores").hide();
			$("#questions").hide();
			$("#score1container").removeClass("span11").addClass("span5");
			$("#question_title").text("");
			$("#question_value").text("");
		}
		
		function setQuestionDisplay()
		{
			$("#question_title").text("Question " + questionCount + ":");
			$("#question_value").text(currentQuestion.text);
		}
		
		function sendGameOverMessage(participant)
		{
			clik.sendMessage("{\"action\":\"gameOver\", \"winner\":\"" + participant + "\"}");
		}
	</script>
</html>
